#malik
import re
import os
import pyrogram
import asyncio
from os import environ
from info import PHT, ADMINS, AUTH_USERS
from Script import script
import time
from typing import List
from pyrogram.types.messages_and_media import message
from pyrogram.types import Message, ChatPermissions, InlineKeyboardButton
from database.users_chats_db import db
from database.ia_filterdb import Media
from pyrogram import Client, filters
from pyrogram.types import InlineKeyboardButton, InlineKeyboardMarkup
from utils import temp, get_size
import json
from collections import defaultdict
from typing import Dict, List, Union

class evamaria(Client):
    filterstore: Dict[str, Dict[str, str]] = defaultdict(dict)
    warndatastore: Dict[
        str, Dict[str, Union[str, int, List[str]]]
    ] = defaultdict(dict)
    warnsettingsstore: Dict[str, str] = defaultdict(dict)

    def __init__(self):
        name = self.__class__.__name__.lower()
        super().__init__(
            ":memory:",
            plugins=dict(root=f"{name}/plugins"),
            workdir=TMP_DOWNLOAD_DIRECTORY,
            api_id=APP_ID,
            api_hash=API_HASH,
            bot_token=BOT_TOKEN,
            parse_mode="html",
            sleep_threshold=60
        )



@Client.on_message(filters.command("star") & filters.incoming & ~filters.edited)
async def star(client, message):
    if len(message.command):
        buttons = [[
            InlineKeyboardButton('‚ùáÔ∏è Add Me To Your Groups ‚ùáÔ∏è', url=f'http://t.me/{temp.U_NAME}?startgroup=true')
        ]]
        reply_markup = InlineKeyboardMarkup(buttons)
        await message.reply_text(
            text=(GHHMT),
            reply_markup=reply_markup,
            parse_mode='html'
        )
        return

@Client.on_message(filters.command('malik') & filters.incoming)
async def get_ststs(bot, message):
    malik = await message.reply('Wait..')
    total_users = await db.total_users_count()
    await malik.edit(
               text=(GHHMT.format(total_users)),
               reply_markup=InlineKeyboardMarkup(
                                      [[
                                        InlineKeyboardButton('üåê Add Me To Your Groups üåê', url=f'http://t.me/{temp.U_NAME}?startgroup=true')
                                      ]]
               ),
               parse_mode='html'
)
# Ban py

@Client.on_message(filters.command("ban"))
async def ban_user(_, message):
    is_admin = await admin_check(message)
    if not is_admin:
        return

    user_id, user_first_name = extract_user(message)

    try:
        await message.chat.kick_member(
            user_id=user_id
        )
    except Exception as error:
        await message.reply_text(
            str(error)
        )
    else:
        if str(user_id).lower().startswith("@"):
            await message.reply_text(
                "Someone else is dusting off..! "
                f"{user_first_name}"
                " Is forbidden."
            )
        else:
            await message.reply_text(
                "Someone else is dusting off..! "
                f"<a href='tg://user?id={user_id}'>"
                f"{user_first_name}"
                "</a>"
                " Is forbidden."
            )

@Client.on_message(filters.command("tban"))
async def temp_ban_user(_, message):
    is_admin = await admin_check(message)
    if not is_admin:
        return

    if not len(message.command) > 1:
        return

    user_id, user_first_name = extract_user(message)

    until_date_val = extract_time(message.command[1])
    if until_date_val is None:
        await message.reply_text(
            (
                "Invalid time type specified. "
                "Expected m, h, or d, Got it: {}"
            ).format(
                message.command[1][-1]
            )
        )
        return

    try:
        await message.chat.kick_member(
            user_id=user_id,
            until_date=until_date_val
        )
    except Exception as error:
        await message.reply_text(
            str(error)
        )
    else:
        if str(user_id).lower().startswith("@"):
            await message.reply_text(
                "Someone else is dusting off..! "
                f"{user_first_name}"
                f" banned for {message.command[1]}!"
            )
        else:
            await message.reply_text(
                "Someone else is dusting off..! "
                f"<a href='tg://user?id={user_id}'>"
                "Lavane"
                "</a>"
                f" banned for {message.command[1]}!"
            )


#unban py


@Client.on_message(filters.command(["unban", "unmute"]))
async def un_ban_user(_, message):
    is_admin = await admin_check(message)
    if not is_admin:
        return

    user_id, user_first_name = extract_user(message)

    try:
        await message.chat.unban_member(
            user_id=user_id
        )
    except Exception as error:
        await message.reply_text(
            str(error)
        )
    else:
        if str(user_id).lower().startswith("@"):
            await message.reply_text(
                "Okay, changed ... now "
                f"{user_first_name} To "
                " You can join the group!"
            )
        else:
            await message.reply_text(
                "Okay, changed ... now "
                f"<a href='tg://user?id={user_id}'>"
                f"{user_first_name}"
                "</a> To "
                " You can join the group!"
            )
# mute py

@Client.on_message(filters.command("mute"))
async def mute_user(_, message):
    is_admin = await admin_check(message)
    if not is_admin:
        return

    user_id, user_first_name = extract_user(message)

    try:
        await message.chat.restrict_member(
            user_id=user_id,
            permissions=ChatPermissions(
            )
        )
    except Exception as error:
        await message.reply_text(
            str(error)
        )
    else:
        if str(user_id).lower().startswith("@"):
            await message.reply_text(
                "üëçüèª "
                f"{user_first_name}"
                " Lavender's mouth is shut! ü§ê"
            )
        else:
            await message.reply_text(
                "üëçüèª "
                f"<a href='tg://user?id={user_id}'>"
                "Of lavender"
                "</a>"
                " The mouth is closed! ü§ê"
            )


@Client.on_message(filters.command("tmute"))
async def temp_mute_user(_, message):
    is_admin = await admin_check(message)
    if not is_admin:
        return

    if not len(message.command) > 1:
        return

    user_id, user_first_name = extract_user(message)

    until_date_val = extract_time(message.command[1])
    if until_date_val is None:
        await message.reply_text(
            (
                "Invalid time type specified. "
                "Expected m, h, or d, Got it: {}"
            ).format(
                message.command[1][-1]
            )
        )
        return

    try:
        await message.chat.restrict_member(
            user_id=user_id,
            permissions=ChatPermissions(
            ),
            until_date=until_date_val
        )
    except Exception as error:
        await message.reply_text(
            str(error)
        )
    else:
        if str(user_id).lower().startswith("@"):
            await message.reply_text(
                "Be quiet for a while! üò†"
                f"{user_first_name}"
                f" muted for {message.command[1]}!"
            )
        else:
            await message.reply_text(
                "Be quiet for a while! üò†"
                f"<a href='tg://user?id={user_id}'>"
                "Of lavender"
                "</a>"
                " Mouth "
                f" muted for {message.command[1]}!"
            )

# user py

from pyrogram.types import Message


def extract_user(message: Message) -> (int, str):
    """extracts the user from a message"""
    user_id = None
    user_first_name = None

    if message.reply_to_message:
        user_id = message.reply_to_message.from_user.id
        user_first_name = message.reply_to_message.from_user.first_name

    elif len(message.command) > 1:
        if (
            len(message.entities) > 1 and
            message.entities[1].type == "text_mention"
        ):
            # 0: is the command used
            # 1: should be the user specified
            required_entity = message.entities[1]
            user_id = required_entity.user.id
            user_first_name = required_entity.user.first_name
        else:
            user_id = message.command[1]
            # don't want to make a request -_-
            user_first_name = user_id

        try:
            user_id = int(user_id)
        except ValueError:
            print("‡¥™‡µä‡¥ü‡µç‡¥ü‡µª")

    else:
        user_id = message.from_user.id
        user_first_name = message.from_user.first_name

    return (user_id, user_first_name)


# string_handling py

MATCH_MD = re.compile(r'\*(.*?)\*|'
                      r'_(.*?)_|'
                      r'`(.*?)`|'
                      r'(?<!\\)(\[.*?\])(\(.*?\))|'
                      r'(?P<esc>[*_`\[])')

# regex to find []() links -> hyperlinks/buttons
LINK_REGEX = re.compile(r'(?<!\\)\[.+?\]\((.*?)\)')
BTN_URL_REGEX = re.compile(
    r"(\[([^\[]+?)\]\(buttonurl:(?:/{0,2})(.+?)(:same)?\))"
)


def button_markdown_parser(msg: Message) -> (str, List):
    # offset = len(args[2]) - len(raw_text)
    # set correct offset relative to command + notename
    markdown_note = None
    if msg.media:
        if msg.caption:
            markdown_note = msg.caption.markdown
    else:
        markdown_note = msg.text.markdown
    note_data = ""
    buttons = []
    if markdown_note is None:
        return note_data, buttons
    #
    if markdown_note.startswith(COMMAND_HAND_LER):
        args = markdown_note.split(None, 2)
        # use python's maxsplit to separate cmd and args
        markdown_note = args[2]
    prev = 0
    for match in BTN_URL_REGEX.finditer(markdown_note):
        # Check if btnurl is escaped
        n_escapes = 0
        to_check = match.start(1) - 1
        while to_check > 0 and markdown_note[to_check] == "\\":
            n_escapes += 1
            to_check -= 1

        # if even, not escaped -> create button
        if n_escapes % 2 == 0:
            # create a thruple with button label, url, and newline status
            if bool(match.group(4)) and buttons:
                buttons[-1].append(InlineKeyboardButton(
                    text=match.group(2),
                    url=match.group(3)
                ))
            else:
                buttons.append([InlineKeyboardButton(
                    text=match.group(2),
                    url=match.group(3)
                )])
            note_data += markdown_note[prev:match.start(1)]
            prev = match.end(1)
        # if odd, escaped -> move along
        else:
            note_data += markdown_note[prev:to_check]
            prev = match.start(1) - 1
    else:
        note_data += markdown_note[prev:]

    return note_data, buttons


def extract_time(time_val):
    if any(time_val.endswith(unit) for unit in ('s', 'm', 'h', 'd')):
        unit = time_val[-1]
        time_num = time_val[:-1]  # type: str
        if not time_num.isdigit():
            return None

        if unit == 's':
            bantime = int(time.time() + int(time_num))
        elif unit == 'm':
            bantime = int(time.time() + int(time_num) * 60)
        elif unit == 'h':
            bantime = int(time.time() + int(time_num) * 60 * 60)
        elif unit == 'd':
            bantime = int(time.time() + int(time_num) * 24 * 60 * 60)
        else:
            # how even...?
            return None
        return bantime
    else:
        return None


def format_welcome_caption(html_string, chat_member):
    return html_string.format(
        dc_id=chat_member.dc_id,
        first_name=chat_member.first_name,
        id=chat_member.id,
        last_name=chat_member.last_name,
        mention=chat_member.mention,
        username=chat_member.username
    )

# admin py
async def admin_check(message: Message) -> bool:
    if not message.from_user:
        return False

    if message.chat.type not in ["supergroup", "channel"]:
        return False

    if message.from_user.id in [
        777000,  # Telegram Service Notifications
        1087968824  # GroupAnonymousBot
    ]:
        return True

    client = message._client
    chat_id = message.chat.id
    user_id = message.from_user.id

    check_status = await client.get_chat_member(
        chat_id=chat_id,
        user_id=user_id
    )
    admin_strings = [
        "creator",
        "administrator"
    ]
    # https://git.colinshark.de/PyroBot/PyroBot/src/branch/master/pyrobot/modules/admin.py#L69
    if check_status.status not in admin_strings:
        return False
    else:
        return True

# report py

@Client.on_message((filters.command(["report"]) | filters.regex("@admins") | filters.regex("@admin")) & filters.group)
async def report_user(bot, message):
    if message.reply_to_message:
        chat_id = message.chat.id
        reporter = str(message.from_user.id)
        mention = message.from_user.mention
        admins = await bot.get_chat_members(chat_id=chat_id, filter="administrators")
        success = True
        report = f"ùñ±ùñæùóâùóàùóãùóçùñæùóã : {mention} ({reporter})" + "\n"
        report += f"ùñ¨ùñæùóåùóåùñ∫ùóÄùñæ : {message.reply_to_message.link}"
        for admin in admins:
            try:
                reported_post = await message.reply_to_message.forward(admin.user.id)
                await reported_post.reply_text(
                    text=report,
                    chat_id=admin.user.id,
                    disable_web_page_preview=True
                )
                success = True
            except:
                pass
        if success:
            await message.reply_text("ùñ±ùñæùóâùóàùóãùóçùñæùñΩ ùóçùóà ùñ†ùñΩùóÜùóÇùóáùóå!")




REPORT = """‚û§ ùêáùêûùê•ùê©: Report ‚ö†Ô∏è

ùöÉùöëùöíùöú ùöåùöòùöñùöñùöäùöóùöç ùöëùöéùöïùöôùöú ùö¢ùöòùöû ùöùùöò ùöõùöéùöôùöòùöõùöù ùöä ùöñùöéùöúùöúùöäùöêùöé ùöòùöõ ùöä ùöûùöúùöéùöõ ùöùùöò ùöùùöëùöé ùöäùöçùöñùöíùöóùöú ùöòùöè ùöùùöëùöé ùöõùöéùöúùöôùöéùöåùöùùöíùöüùöé ùöêùöõùöòùöûùöô. ùô≥ùöòùöó'ùöù ùöñùöíùöúùöûùöúùöé ùöùùöëùöíùöú ùöåùöòùöñùöñùöäùöóùöç.

‚û§ ùêÇùê®ùê¶ùê¶ùêöùêßùêùùê¨ ùêöùêßùêù ùêîùê¨ùêöùê†ùêû:

‚û™/report ùóàùóã @admins - ùñ≥ùóà ùóãùñæùóâùóàùóãùóç ùñ∫ ùóéùóåùñæùóã ùóçùóà ùóçùóÅùñæ ùñ∫ùñΩùóÜùóÇùóáùóå (ùóãùñæùóâùóÖùóí ùóçùóà ùñ∫ ùóÜùñæùóåùóåùñ∫ùóÄùñæ)."""


PURGE = """<b>Purge</b>
    
Delete A Lot Of Messages From Groups! 
    
 <b>ADMIN</b> 

‚óâ /purge :- Delete All Messages From The Replied To Message, To The Current Message"""

MUTE = """‚û§ <b>ùêáùêûùê•ùê©: Mute üö´

ùöÉùöëùöéùöúùöé ùöäùöõùöé ùöùùöëùöé ùöåùöòùöñùöñùöäùöóùöçùöú ùöä ùöêùöõùöòùöûùöô ùöäùöçùöñùöíùöó ùöåùöäùöó ùöûùöúùöé ùöùùöò ùöñùöäùöóùöäùöêùöé ùöùùöëùöéùöíùöõ ùöêùöõùöòùöûùöô ùöñùöòùöõùöé ùöéùöèùöèùöíùöåùöíùöéùöóùöùùöïùö¢.

‚û™/ban: ùñ≥ùóà ùñªùñ∫ùóá ùñ∫ ùóéùóåùñæùóã ùñøùóãùóàùóÜ ùóçùóÅùñæ ùóÄùóãùóàùóéùóâ.
‚û™/unban: ùñ≥ùóà ùóéùóáùñªùñ∫ùóá ùñ∫ ùóéùóåùñæùóã ùóÇùóá ùóçùóÅùñæ ùóÄùóãùóàùóéùóâ.
‚û™/tban: ùñ≥ùóà ùóçùñæùóÜùóâùóàùóãùñ∫ùóãùóÇùóÖùóí ùñªùñ∫ùóá ùñ∫ ùóéùóåùñæùóã.
‚û™/mute: ùñ≥ùóà ùóÜùóéùóçùñæ ùñ∫ ùóéùóåùñæùóã ùóÇùóá ùóçùóÅùñæ ùóÄùóãùóàùóéùóâ.
‚û™/unmute: ùñ≥ùóà ùóéùóáùóÜùóéùóçùñæ ùñ∫ ùóéùóåùñæùóã ùóÇùóá ùóçùóÅùñæ ùóÄùóãùóàùóéùóâ.
‚û™/tmute: ùñ≥ùóà ùóçùñæùóÜùóâùóàùóãùñ∫ùóãùóÇùóÖùóí ùóÜùóéùóçùñæ ùñ∫ ùóéùóåùñæùóã.

‚û§ ùñ≠ùóàùóçùñæ:
ùñ∂ùóÅùóÇùóÖùñæ ùóéùóåùóÇùóáùóÄ /tmute ùóàùóã /tban ùóíùóàùóé ùóåùóÅùóàùóéùóÖùñΩ ùóåùóâùñæùñºùóÇùñøùóí ùóçùóÅùñæ ùóçùóÇùóÜùñæ ùóÖùóÇùóÜùóÇùóç.

‚ûõùñ§ùóëùñ∫ùóÜùóâùóÖùñæ: /ùóçùñªùñ∫ùóá 2ùñΩ ùóàùóã /ùóçùóÜùóéùóçùñæ 2ùñΩ.
ùñ∏ùóàùóé ùñºùñ∫ùóá ùóéùóåùñæ ùóèùñ∫ùóÖùóéùñæùóå: ùóÜ/ùóÅ/ùñΩ. 
 ‚Ä¢ ùóÜ = ùóÜùóÇùóáùóéùóçùñæùóå
 ‚Ä¢ ùóÅ = ùóÅùóàùóéùóãùóå
 ‚Ä¢ ùñΩ = ùñΩùñ∫ùóíùóå</b>"""

MQTT = """<b>‚ö†Ô∏è Hey, {}!.. 

Your word</b> üëâ <s>{}</S>...
<b>is No Movie/Series Related to the Given Word Was Found ü•∫
Please Go to Google and Confirm the Correct Spelling ü•∫</b> <b><a href=https://www.google.com>Google</a></b>"""


WCM = """<b>Hey {} .!   

üîπ Welcome to Our Group.. <s>{}</s>

üîπ This is a Movie Group

üîπ All Categories Of Movies
      Available Here. .

üîπ Just Tipe The Movie Name

üîπ Our Will Send Your Movie..

üîπ please read group rules

üîπ ¬©Mantained by: sahid malik</b>"""

STTS = """<b>üóÇùöÉùôæùöÉùô∞ùôª ùôµùô∏ùôªùô¥ùöÇ: <code>{}</code>
üë®‚Äçüë©‚Äçüëß‚Äçüëß ùöÉùôæùöÉùô∞ùôª ùöÑùöÇùô¥ùöÅùöÇ: <code>{}</code>
ü§ø ùöÉùôæùöÉùô∞ùôª ùô≤ùô∑ùô∞ùöÉùöÇ: <code>{}</code>
‚è≥ ùöÑùöÇùô¥ùô≥ ùöÇùöÉùôæùöÅùô∞ùô∂ùô¥: <code>{}</code> ùôºùöíùô±
‚åõÔ∏è ùôµùöÅùô¥ùô¥ ùöÇùöÉùôæùöÅùô∞ùô∂ùô¥: <code>{}</code> ùôºùöíùô±</b> """


GHHMT = """<b>Thanks For {}.User... üíñ 

Thanks For Your Support...

ùñ©ùóéùóåùóç ùñ†ùñΩùñΩ ùñÆùóéùóã ùñ°ùóàùóç ùñ≥ùóà ùñ∏ùóàùóéùóã ùñ¶ùóãùóàùóéùóâ ùñ†ùóå ùñ†ùñΩùóÜùóÇùóá, ùñ®ùóç ùñ∂ùóÇùóÖùóÖ ùñØùóãùóàùóèùóÇùñΩùñæ ùñ¨ùóàùóèùóÇùñæùóå ùñ≥ùóÅùñæùóãùñæ... üòé


     ‚ôãÔ∏è ùóôùó≤ùóÆùòÅùòÇùóøùó≤ùòÄ ‚ôãÔ∏è

‚ú™ AutoFilter, Manual Filter
‚ú™ IMDb HD Posters
‚ú™ IMDb Real Details
‚ú™ Two Buttons Mode
‚ú™ Force Subscribe
‚ú™ Extra Features: download songs, download you tube video, URL Shortner,  

‚öô More Features Adding Soon</b> üòé"""

TMP_DOWNLOAD_DIRECTORY = environ.get("TMP_DOWNLOAD_DIRECTORY", "./DOWNLOADS/")
PPC = environ.get("PPC", "https://telegra.ph/file/3b6afd6c6fcd09606ea9f.jpg")
MQTTP = environ.get("MQTTP", "https://telegra.ph/file/f8a3c7a57376427646f39.jpg")
TG_MAX_SELECT_LEN = environ.get("TG_MAX_SELECT_LEN", "100")
WCM_P = environ.get("WCM_P", "https://telegra.ph/file/bdaa63ddf255fd3506f0a.jpg")
SMART_PIC = environ.get("SMART_PIC", "https://telegra.ph/file/7cf564b255461abfc75fe.jpg")

